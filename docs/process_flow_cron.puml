@startuml process flow with cron
autonumber

participant Frontend as f
participant PdfParser as pdfp
participant CitationExtractor as ce
participant ReferenceFetcher as rf

participant "**Backend**" as b
database    Database   as db #Blue
database    Filesystem as fs #Cyan
database    Internet as internet #Green


group ADD PDF

f -[#Red]> b: POST /pdf filename.pdf
activate b
b -[#Cyan]> fs: save pdf as $uuid4.pdf
b -[#Blue]> db: INSERT Pdf(id = $uuid4, parsed=False)
b --[#Red]> f: pdf_id
deactivate b
end

group PARSE PDF
pdfp -> pdfp: CRON trigger
activate pdfp
group Fetch files
pdfp -[#Red]> b: GET /pdf?parsed=False
activate b
b -[#Blue]> db: SELECT * FROM Pdf \nWHERE filename != None AND parsed == False
db --[#Blue]> b: [Pdf_id1, Pdf_id2, ...]
b -[#Cyan]> fs: fetch [pdf_id1.pdf, pdf_id2.pdf, ...]
fs --[#Cyan]> b: [pdf_id1.pdf, pdf_id2.pdf, ...]
b --[#Red]> pdfp: [pdf_id1.pdf, pdf_id2.pdf, ...]
deactivate b
end

group Loop over files
pdfp -> pdfp: parse PDF
pdfp -[#Red]> b: POST /publication Publication(filename=pdf_id1, raw_text = ...)
activate b
b -[#Blue]> db: INSERT Publication(filename=pdf_id1, analyse_refs=True, raw_text = ...)
b -[#Blue]> db: UPDATE Pdf SET parsed = True WHERE Pdf.id == Publication.filename
b --[#Red]> pdfp: publication1_id
deactivate b
deactivate pdfp
end
end


group EXTRACT CITATIONS
ce -> ce: CRON trigger
activate ce

group Fetch publications
ce -[#Red]> b: GET /publication?analyse_refs=True&raw_text!=None
activate b
b -[#Blue]> db: SELECT * FROM Publication \nWHERE analyse_refs == True AND raw_text != None
db --[#Blue]> b: [publication1, publication2, ...]
b --[#Red]> ce: [publication1, publication2, ...]
deactivate b
end

group Process references
ce -> ce: Extract references
group Loop over references
ce -[#Red]> b: POST /publication Publication(analyse_refs = False)
activate b
b -[#Blue]> db: INSERT Publication(id = uuid4, analyse_refs = False)
b --[#Red]> ce: publication_id
deactivate b
end
end

ce -> ce: Extract citations
group Loop over citations
ce -[#Red]> b: POST /citation Citation(in_publication=pub_id1, reference=pub_id2, raw_text=...)
activate b
b -[#Blue]> db: INSERT Citation(in_publication=pub_id1, reference=pub_id2, raw_text=...)
b --[#Red]> ce: citation_id
deactivate b
deactivate ce
end
end

group FETCH REFERENCES
rf -> rf: CRON trigger
activate rf
group Fetch publications with missing file
rf -[#Red]> b: GET /publication?filename=None
activate b
b -[#Blue]> db: SELECT * FROM Publication \nWHERE filename == None
db --[#Blue]> b: [publication1, publication2, ...]
b --[#Red]> rf: [publication1, publication2, ...]
deactivate b
end
rf -> rf: Parse Publications

group Download missing file
rf -[#Green]> internet: FetchMethod1(publication1)
internet --[#Green]> rf: NOT OK
activate b
rf -[#Red]> b: POST /fetchresult FetchResult(result=False)
b -[#Blue]> db: INSERT FetchResult(time=now(), result=False)
b --[#Red]> rf: fetchresult_id
deactivate b

rf -[#Green]> internet: FetchMethod2(publication1)
internet --[#Green]> rf: publication1.pdf
rf -[#Red]> b: POST /fetchresult FetchResult(result=True)
activate b
b -[#Blue]> db: INSERT FetchResult(time=now(), result=True)
b --[#Red]> rf: fetchresult_id
deactivate b

rf -[#Red]> b: POST /pdf publication1.pdf
activate b
b -[#Cyan]> fs: save pdf as $uuid4.pdf
b -[#Blue]> db: INSERT Pdf(id = $uuid4, parsed=False)
b --[#Red]> rf: pdf_id
deactivate b

rf -[#Red]> b: PATCH /publication Publication(id=publication1_id, filename=pdf_id)
activate b
b -[#Blue]> db: UPDATE Publication(id=publication1_id, filename=pdf_id)
b --[#Red]> rf: publication1_id
deactivate b
deactivate rf
end
end

@enduml

